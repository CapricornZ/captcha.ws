#set( $ContextPath = ${request.contextPath} )

<link rel="stylesheet" href="${ContextPath}/css/bootstrap.css" >
<link href="${ContextPath}/css/bootstrap-dialog.min.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="${ContextPath}/js/jquery/jquery-1.11.2.min.js"></script>
<script src="${ContextPath}/js/bootstrap.js"></script>
<script src="${ContextPath}/js/bootstrap-dialog.min.js"></script>
<script src="${ContextPath}/js/bootstrap.min.js"></script>

<style>
   .login-dialog .modal-dialog .modal-body .modal-header .modal-footer{
        width: 800px;
    }
</style>
        
<script type="text/javascript">
	$(function(){
		$("#OK").click(function(){
		
			var radio = $("input[name='operation']:checked");
			if(radio.length == 0){
				alert("选择Operation先");return;
			}
			
			var hosts = new Array();
			$("input[type='checkbox']:checked").each(function(){
				hosts.push($(this).val());
			});
			if(hosts.length == 0){
				alert("选择HOST先");return;
			}
			
			var assignOps = {
				'hosts' : hosts,
				'operationID' : $(radio[0]).val()
			};
			$.ajax({
			    url : '${ContextPath}/command/operation/assign.do',
    			type: 'POST',
    			data:JSON.stringify(assignOps),
				contentType: 'application/json;charset=utf-8;',
				error: function(msg) { alert("error"); },
				complete: function(msg) { console.log("complete"); },
				success: function(msg) { 
				
					alert("操作成功");
					console.log("complete");
				}     
			});
		});
		
		$.get("${ContextPath}/command/client/list.do",
			function(result){

				var table = $('#hostTable');
				for(var i=0; i<result.length; i++){
				
					var row = "<tr>";
					row += "<td><input name='checkHost' type='checkbox' value='" + result[i].ip + "'/>" + result[i].ip + "</td>";
					if(result[i].operation.length > 0){
						var ops = "";
						for(var j=0; j<result[i].operation.length; j++){
							ops += result[i].operation[j].type + "[" + result[i].operation[j].id + "] @" + result[i].operation[j].startTime + "<br/>"
						}
						row += "<td>"+ops+"</td>";
					} else
						row += "<td></td>";
					row += "</tr>";
					table.append(row);
				}
			}
		);
		
		$("button[toggle='DELETE']").click(function(){
			var operationID = $(this).attr("opsID");
			$.ajax({
			    url : '${ContextPath}/command/operation/' + operationID + '.do',
    			type: 'DELETE',
				contentType: 'application/json;charset=utf-8;',
				error: function(msg) { alert("error"); },
				complete: function(msg) { console.log("complete"); },
				success: function(msg) { 
					console.log("success");
					alert("操作成功");
					$("tr[opsID='" + operationID + "']").remove();
				}     
			});
		});
	
		$("button[toggle='MODIFY']").click(function(){

			var opsID = $(this).attr("opsID");
			BootstrapDialog.show({
				cssClass: 'login-dialog',
				title:"修改Operation",
	            message: $('<div></div>').load('${ContextPath}/command/operation/' + opsID + '.do'),
	            buttons:[{
	            	label:"保存",
	            	action:function(dialogItself){
	            		var bidOps = {
							id:$('#operationID').val(),
							type:"BID",
							startTime:$('#startTimeInput').val(),
							expireTime:$('#expireTimeInput').val(),
							price:$('#price').val(),
							content:$('#jsonContent').val()
						};
						
						$.ajax({
						    url: '${ContextPath}/command/operation/BID/' + $('#operationID').val() + '.do',
			    			type: 'PUT',
			    			data:JSON.stringify(bidOps),
							contentType: 'application/json;charset=utf-8;',
							error: function(msg) { alert("error"); },
							complete: function(msg) { console.log("complete"); },
							success: function(msg) { 
								console.log("success");
								alert("保存成功");
								dialogItself.close();
							}     
						});
	            	}
	            },{
	            	label:"取消",
	            	action: function(dialogItself){
	                    dialogItself.close();
	                }
	            }]
	        });
		});
	});
</script>

<div class="container-fluid">
	<div class="row">
		<div class="col-sm-7"><!--MIDDLE content-->
			<legend>操作列表</legend>
			<table class="table table-striped table-bordered">
				<tr>
					<th>ID</th>
					<th>类型</th>
					<th>关联の客户端</th>
					<th>触发时间</th>
					<th>其他</th>
					<th>操作</th>
					<th></th>
				</tr>
				#foreach(${operation} in ${operations})
				<tr opsID="${operation.id}">
					<td>${operation.id}</td>
					<td>${operation.type}</td>
					<td>${operation.clients.size()}</td>
					<td>${operation.startTime}</td>
					<td>$!{operation.price}</td>
					<td>
						<button class="btn btn-primary" toggle="MODIFY" opsID="${operation.id}"><i class="icon-edit icon-white"></i>修改</button>
						#if(${operation.clients.size()} == 0)
						<button class="btn btn-primary" toggle="DELETE" opsID="${operation.id}"><i class="icon-trash icon-white"></i>删除</button>
						#else
						<button class="btn btn-primary disabled" toggle="DELETE" opsID="${operation.id}"><i class="icon-trash icon-white"></i>删除</button>
						#end
					</td>
					<td><input type="radio" name="operation" value="${operation.id}"></input></td>
				</tr>
				#end
				<!--<tr>
					<td colspan='4'></td>
					<td><button class="btn btn-primary" toggle="CREATE" href="#newOperationFrom">创建</button></td>
				</tr>-->
			</table>
		</div>
		<div class="col-sm-5"><!--Sidebar content-->
			<form class="form-horizontal" onsubmit="return false;">
				<fieldset>
	        		<legend>客户端列表</legend>
	        		<div class="control-group">
	        			<table id="hostTable" class="table table-striped table-bordered table-hover">
							<tr>
								<th>HOST/IP</th>
								<th>已分配の操作</th>
							</tr>
						</table>
	        		</div>
	        		<div class="form-actions">
						<button class="btn btn-primary" type="submit" id="OK">分配操作</button>
						<button class="btn">取消</button>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
</div>
